(function(){const S={null:"#a3d165",1:"#ffa500",2:"#e53935",3:"#800080",4:"#7b68ee",5:"#ffffff",6:"#696969",7:"#b9b9b9",8:"#0368ae"},f="#008102",E=2,b={template:'<div ref="canvas" class="svg-layout"></div>',props:{svgUrl:String,slots:Array,zones:Array,configId:Number},data(){return{selected:new Set,lastIndex:null,isDragging:!1,dragRectEl:null,nodesArray:[],nodesById:{},slotById:{},statusColor:S,zoneColorMap:{},changed:{},popoverEl:null,currentPopoverNode:null,popoverTimeout:null,hasSingleZone:!1}},methods:{toggleNode(e,i){const s=+e.dataset.slotId;this.slotById[s].status_id!==2&&(i?(this.selected.add(s),e.classList.add("selected")):(this.selected.delete(s),e.classList.remove("selected")))},clearSelection(){this.nodesArray.forEach(e=>e.classList.remove("selected")),this.selected.clear()},writeHidden(e=Object.values(this.changed)){document.getElementById("slot_labels_input").value=JSON.stringify(e)},startDrag(e){if(e.button!==0)return;if(e.preventDefault(),this.hidePopover(),this.dragRectEl){try{this.dragRectEl.remove()}catch{}this.dragRectEl=null}this.isDragging=!0;const i=this.$refs.canvas.getBoundingClientRect();this.dragStartX=e.clientX-i.left,this.dragStartY=e.clientY-i.top,this.dragRectEl=document.createElement("div"),this.dragRectEl.className="drag-select-rect",Object.assign(this.dragRectEl.style,{left:this.dragStartX+"px",top:this.dragStartY+"px",width:0,height:0}),this.$refs.canvas.appendChild(this.dragRectEl),this.previewSelection=new Set,window.addEventListener("mousemove",this.onDrag,{passive:!0}),window.addEventListener("mouseup",this.stopDrag,{passive:!0}),window.addEventListener("blur",this.stopDrag,{passive:!0}),this.$refs.canvas.addEventListener("mouseleave",this.stopDrag,{passive:!0}),document.addEventListener("visibilitychange",this._visStopDrag,{passive:!0})},onDrag(e){if(!this.isDragging)return;const i=this.$refs.canvas.getBoundingClientRect(),s=e.clientX-i.left,t=e.clientY-i.top,o=Math.min(s,this.dragStartX),n=Math.min(t,this.dragStartY),r=Math.abs(s-this.dragStartX),u=Math.abs(t-this.dragStartY);Object.assign(this.dragRectEl.style,{left:o+"px",top:n+"px",width:r+"px",height:u+"px"});const h=this.dragRectEl.getBoundingClientRect();this.previewSelection.forEach(d=>{const l=this.nodesById[d];l&&!this.selected.has(d)&&l.classList.remove("preview-selected")}),this.previewSelection.clear(),this.nodesArray.forEach(d=>{const l=+d.dataset.slotId;if(this.slotById[l].status_id===2)return;const c=d.getBoundingClientRect();!(c.right<h.left||c.left>h.right||c.bottom<h.top||c.top>h.bottom)?(this.previewSelection.add(l),this.selected.has(l)||d.classList.add("preview-selected")):this.selected.has(l)||d.classList.remove("preview-selected")})},_visStopDrag(){document.visibilityState==="hidden"&&this.stopDrag()},stopDrag(e){var i;if(this.isDragging){if(this.isDragging=!1,window.removeEventListener("mousemove",this.onDrag),window.removeEventListener("mouseup",this.stopDrag),window.removeEventListener("blur",this.stopDrag),(i=this.$refs.canvas)==null||i.removeEventListener("mouseleave",this.stopDrag),document.removeEventListener("visibilitychange",this._visStopDrag),this.dragRectEl){const s=this.dragRectEl.getBoundingClientRect();e&&(e.ctrlKey||e.metaKey)||this.clearSelection(),this.nodesArray.forEach(o=>{const n=o.getBoundingClientRect();!(n.right<s.left||n.left>s.right||n.bottom<s.top||n.top>s.bottom)&&this.toggleNode(o,!0),o.classList.remove("preview-selected")});try{this.dragRectEl.remove()}catch{}this.dragRectEl=null}this.previewSelection.clear(),this.writeHidden()}},createPopover(){this.popoverEl||(this.popoverEl=document.createElement("div"),this.popoverEl.className="slot-popover",this.popoverEl.style.cssText=`
                        position: fixed;
                        background: rgba(0, 0, 0, 0.9);
                        color: white;
                        padding: 10px 15px;
                        border-radius: 6px;
                        font-size: 13px;
                        line-height: 1.5;
                        pointer-events: none;
                        z-index: 10000;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        max-width: 250px;
                        word-wrap: break-word;
                        display: none;
                    `,document.body.appendChild(this.popoverEl))},showPopover(e,i){var u,h;if(this.isDragging)return;const s=+e.dataset.slotId,t=this.slotById[s];if(!t)return;this.createPopover();let o="";const n=t.status_id,r=n===null?f:this.statusColor[n]||"#666";if(t.name&&(o+=`<div style="font-weight: 600; margin-bottom: 5px;">
                        <span style="color: ${r};">‚óè</span> ${this.escapeHtml(t.name)}
                    </div>`),n===2&&t.confirmation_code){const d=window.currentLocale||"es",l=((h=(u=window.sessionTranslations)==null?void 0:u.click_to_copy)==null?void 0:h[d])||"Click para copiar";o+=`<div style="color: #ffffff; font-size: 13px; font-weight: 600; margin-bottom: 5px;">
                        üõí <span>${this.escapeHtml(t.confirmation_code)}</span>
                        <div style="font-size: 11px; color: #aaa; margin-top: 4px;">${l}</div>
                    </div>`}t.comment&&(o+=`<div style="color: #e0e0e0; font-size: 12px;">
                        ${this.escapeHtml(t.comment)}
                    </div>`),o&&(this.popoverEl.innerHTML=o,this.currentPopoverNode=e,this.positionPopover(i),clearTimeout(this.popoverTimeout),this.popoverTimeout=setTimeout(()=>{this.popoverEl&&this.currentPopoverNode===e&&(this.popoverEl.style.display="block")},300))},positionPopover(e){if(!this.popoverEl)return;const i=15;let s=e.clientX+i,t=e.clientY+i;const o=this.popoverEl.getBoundingClientRect();s+o.width>window.innerWidth&&(s=e.clientX-o.width-i),t+o.height>window.innerHeight&&(t=e.clientY-o.height-i),this.popoverEl.style.left=s+"px",this.popoverEl.style.top=t+"px"},hidePopover(){clearTimeout(this.popoverTimeout),this.popoverEl&&(this.popoverEl.style.display="none"),this.currentPopoverNode=null},escapeHtml(e){const i=document.createElement("div");return i.textContent=e,i.innerHTML},openEditModal(){if(this.selected.size===0){const r="Selecciona una butaca.";window.swal?swal({title:r,icon:"warning",buttons:{confirm:{text:"OK",visible:!0,className:"bg-primary",closeModal:!0}}}):alert(r);return}$("#set-slot-name").parent().hide(),$("#set-slot-x").parent().hide(),$("#set-slot-y").parent().hide(),$("#set-slot-zone").parent().hide();const e=this._selectedIds(),i=e.length===1?e[0]:null,{mixed:s,value:t}=this._commonOf(r=>r.status_id??null),{mixed:o,value:n}=this._commonOf(r=>r.comment??"");i?$("#set-slot-id").val(i):$("#set-slot-id").val("M√∫ltiples"),s?$("#set-slot-status").val("null"):$("#set-slot-status").val(t===null?"null":String(t)),$('#setSlotProperties input[name="comment"]').val(o?"":n),$("#setSlotProperties").modal("show")},applyModalChanges(){const e=$("#set-slot-status").val(),i=e==="null"?null:+e,s=$('#setSlotProperties input[name="comment"]').val();this.selected.forEach(t=>{const o=this.nodesById[t],n=this.slotById[t];if(n.status_id===2)return;n.status_id=i,n.comment=s;const r=i===null?f:this.statusColor[i]??"#666";if(o.style.fill=r,this.hasSingleZone)o.style.stroke=r,o.style.strokeWidth=E;else{const u=this.zoneColorMap[n.zone_id]||"#cccccc";o.style.stroke=u,o.style.strokeWidth=1}this.changed[t]={id:t,comment:n.comment??null,status_id:n.status_id??null}}),this.writeHidden(),$("#setSlotProperties").modal("hide")},_selectedIds(){return[...this.selected]},_commonOf(e){const i=this._selectedIds();if(i.length===0)return{mixed:!1,value:null};let s;for(const t of i){const o=this.slotById[t]??{},n=e(o);if(s===void 0)s=n;else if(n!==s)return{mixed:!0,value:null}}return{mixed:!1,value:s??null}}},mounted(){const e=this.$refs.canvas;e.addEventListener("mousedown",this.startDrag),document.addEventListener("keydown",s=>{s.key==="Escape"&&(this.stopDrag(s),this.hidePopover())}),this.zoneColorMap=Object.fromEntries(this.zones.map(s=>[s.id,s.color]));const i=new Set(this.slots.map(s=>s.zone_id).filter(s=>s!=null));this.hasSingleZone=i.size===1,fetch(this.svgUrl).then(s=>s.text()).then(s=>{if(e.innerHTML=s,this.slotById=Object.fromEntries(this.slots.map(t=>[Number(t.id),t])),this.nodesArray=[...e.querySelectorAll(".slot")],this.nodesById=Object.fromEntries(this.nodesArray.map(t=>[+t.dataset.slotId,t])),this.nodesArray.forEach((t,o)=>{const n=+t.dataset.slotId,r=this.slotById[n]??(this.slotById[n]={id:n}),u=r.status_id,h=u==null,d=h?f:this.statusColor[u]??"#666";if(t.style.fill=d,this.hasSingleZone)t.style.stroke=h?f:d,t.style.strokeWidth=E;else{const l=this.zoneColorMap[r.zone_id]||"#cccccc";t.style.stroke=l,t.style.strokeWidth=1}t.style.cursor=r.status_id===2?"not-allowed":"pointer",t.addEventListener("mouseenter",l=>{this.showPopover(t,l)}),t.addEventListener("mousemove",l=>{this.currentPopoverNode===t&&this.popoverEl&&this.positionPopover(l)}),t.addEventListener("mouseleave",()=>{this.currentPopoverNode===t&&this.hidePopover()}),t.addEventListener("click",l=>{if(!this.isDragging){if(r.status_id===2&&r.confirmation_code){l.stopPropagation(),this.hidePopover(),(c=>navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(c):new Promise((p,m)=>{const a=document.createElement("textarea");a.value=c,a.style.position="fixed",a.style.left="-999999px",a.style.top="-999999px",document.body.appendChild(a),a.focus(),a.select();try{const g=document.execCommand("copy");document.body.removeChild(a),g?p():m(new Error("execCommand failed"))}catch(g){document.body.removeChild(a),m(g)}}))(r.confirmation_code).then(()=>{var m,a;const c=window.currentLocale||"es",p=((a=(m=window.sessionTranslations)==null?void 0:m.code_copied)==null?void 0:a[c])||"C√≥digo copiado";new Noty({type:"success",text:`<strong>${p}:</strong> ${r.confirmation_code}`}).show()}).catch(c=>{var a,g;console.error("‚ùå Error copiando:",c);const p=window.currentLocale||"es",m=((g=(a=window.sessionTranslations)==null?void 0:a.copy_error)==null?void 0:g[p])||"Error al copiar";new Noty({type:"error",text:`<strong>${m}.</strong> `}).show()});return}if(this.hidePopover(),l.shiftKey&&this.lastIndex!==null){const[y,c]=this.lastIndex<o?[this.lastIndex,o]:[o,this.lastIndex];for(let p=y;p<=c;p++){const m=this.nodesArray[p];this.toggleNode(m,!0)}}else l.ctrlKey||l.metaKey?this.toggleNode(t,!this.selected.has(n)):(this.clearSelection(),this.toggleNode(t,!0));this.lastIndex=o,this.writeHidden()}})}),document.querySelector(".selection-btn-edit").addEventListener("click",()=>this.openEditModal()),document.querySelector("#setSlotProperties .btn-set").addEventListener("click",()=>this.applyModalChanges()),v.dataset.zoomEnabled==="1"){const t=e.querySelector("svg");this.panzoom=Panzoom(t,{maxScale:5,minScale:.5,step:.3,contain:"outside",disablePan:!0,cursor:"",handleStartEvent:o=>{}}),t.parentElement.addEventListener("wheel",this.panzoom.zoomWithWheel),document.querySelector(".btn-zoom-in").addEventListener("click",()=>this.panzoom.zoomIn()),document.querySelector(".btn-zoom-out").addEventListener("click",()=>this.panzoom.zoomOut()),document.querySelector(".btn-reset-zoom").addEventListener("click",()=>this.panzoom.reset())}}).catch(console.error)},beforeUnmount(){this.popoverEl&&(this.popoverEl.remove(),this.popoverEl=null),clearTimeout(this.popoverTimeout)}},v=document.getElementById("svg-layout"),w=document.getElementById("svg-canvas");v&&w&&Vue.createApp(b,{svgUrl:v.dataset.svgUrl,slots:JSON.parse(v.dataset.slots),zones:JSON.parse(v.dataset.zones),configId:parseInt(v.dataset.configId,10)}).mount(w)})();
