(function(){const E={null:"#a3d165",1:"#ffa500",2:"#e53935",3:"#800080",4:"#7b68ee",5:"#ffffff",6:"#696969",7:"#b9b9b9",8:"#0368ae"},m="#008102",v=2,S={template:'<div ref="canvas" class="svg-layout"></div>',props:{svgUrl:String,slots:Array,zones:Array,configId:Number},data(){return{selected:new Set,lastIndex:null,isDragging:!1,dragRectEl:null,dragStartX:0,dragStartY:0,nodesArray:[],nodesById:{},slotById:{},statusColor:E,zoneColorMap:{},changed:{},popoverEl:null,currentPopoverNode:null,popoverTimeout:null,hasSingleZone:!1}},methods:{valorComun(t,e){if(!t.length)return null;const o=t[0][e];return t.every(n=>n[e]===o)?o:null},toggleNode(t,e){const o=+t.dataset.slotId;e?(this.selected.add(o),t.classList.add("selected")):(this.selected.delete(o),t.classList.remove("selected"))},clearSelection(){this.nodesArray.forEach(t=>t.classList.remove("selected")),this.selected.clear()},writeHidden(t=[...this.selected]){document.getElementById("slot_labels_input").value=JSON.stringify(t)},startDrag(t){if(t.button!==0||t.target.classList.contains("slot"))return;t.preventDefault(),this.hidePopover(),this.isDragging=!0;const e=this.$refs.canvas.getBoundingClientRect();this.dragStartX=t.clientX-e.left,this.dragStartY=t.clientY-e.top,this.dragRectEl=document.createElement("div"),this.dragRectEl.className="drag-select-rect",Object.assign(this.dragRectEl.style,{left:this.dragStartX+"px",top:this.dragStartY+"px",width:"0px",height:"0px"}),this.$refs.canvas.appendChild(this.dragRectEl),window.addEventListener("mousemove",this.onDrag),window.addEventListener("mouseup",this.stopDrag),document.addEventListener("mouseleave",this.cancelDrag)},onDrag(t){if(!this.isDragging||!this.dragRectEl)return;const e=this.$refs.canvas.getBoundingClientRect(),o=t.clientX-e.left,n=t.clientY-e.top,i=Math.min(o,this.dragStartX),a=Math.min(n,this.dragStartY),c=Math.abs(o-this.dragStartX),l=Math.abs(n-this.dragStartY);Object.assign(this.dragRectEl.style,{left:i+"px",top:a+"px",width:c+"px",height:l+"px"})},stopDrag(t){if(this.isDragging){if(this.dragRectEl){const e=this.dragRectEl.getBoundingClientRect();e.width>5&&e.height>5&&(t.ctrlKey||t.metaKey||this.clearSelection(),this.nodesArray.forEach(i=>{const a=i.getBoundingClientRect(),c=a.left+a.width/2,l=a.top+a.height/2;c>=e.left&&c<=e.right&&l>=e.top&&l<=e.bottom&&this.toggleNode(i,!0)}),this.writeHidden())}this.cleanupDrag()}},cancelDrag(){this.isDragging&&this.cleanupDrag()},cleanupDrag(){this.isDragging=!1,window.removeEventListener("mousemove",this.onDrag),window.removeEventListener("mouseup",this.stopDrag),document.removeEventListener("mouseleave",this.cancelDrag),this.dragRectEl&&this.dragRectEl.parentNode&&this.dragRectEl.remove(),this.dragRectEl=null},createPopover(){this.popoverEl||(this.popoverEl=document.createElement("div"),this.popoverEl.className="slot-popover",this.popoverEl.style.cssText=`
                        position: fixed;
                        background: rgba(0, 0, 0, 0.9);
                        color: white;
                        padding: 10px 15px;
                        border-radius: 6px;
                        font-size: 13px;
                        line-height: 1.5;
                        pointer-events: none;
                        z-index: 10000;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        max-width: 250px;
                        word-wrap: break-word;
                        display: none;
                    `,document.body.appendChild(this.popoverEl))},showPopover(t,e){if(this.isDragging)return;const o=+t.dataset.slotId,n=this.slotById[o];if(!n)return;this.createPopover();let i="";const a=n.status_id,c=a===null?m:this.statusColor[a]||"#666";n.name&&(i+=`<div style="font-weight: 600; margin-bottom: 5px;">
                        <span style="color: ${c};">●</span> ${this.escapeHtml(n.name)}
                    </div>`),n.comment&&(i+=`<div style="color: #e0e0e0; font-size: 12px;">
                        ${this.escapeHtml(n.comment)}
                    </div>`),i&&(this.popoverEl.innerHTML=i,this.currentPopoverNode=t,this.positionPopover(e),clearTimeout(this.popoverTimeout),this.popoverTimeout=setTimeout(()=>{this.popoverEl&&this.currentPopoverNode===t&&(this.popoverEl.style.display="block")},300))},positionPopover(t){if(!this.popoverEl)return;const e=15;let o=t.clientX+e,n=t.clientY+e;const i=this.popoverEl.getBoundingClientRect();o+i.width>window.innerWidth&&(o=t.clientX-i.width-e),n+i.height>window.innerHeight&&(n=t.clientY-i.height-e),this.popoverEl.style.left=o+"px",this.popoverEl.style.top=n+"px"},hidePopover(){clearTimeout(this.popoverTimeout),this.popoverEl&&(this.popoverEl.style.display="none"),this.currentPopoverNode=null},escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML},openEditModal(){if(this.selected.size===0){const l="Selecciona una butaca.";window.swal?swal({title:l,icon:"warning",buttons:{confirm:{text:"OK",visible:!0,className:"bg-primary",closeModal:!0}}}):alert(l);return}const t=document.getElementById("set-slot-zone");t.innerHTML='<option value="">-- Selecciona zona --</option>',this.zones.forEach(l=>{const s=document.createElement("option");s.value=l.id,s.textContent=l.name,t.appendChild(s)});const e=[...this.selected].map(l=>this.slotById[l]),o=this.valorComun(e,"zone_id"),n=this.valorComun(e,"x"),i=this.valorComun(e,"y"),a=this.valorComun(e,"status_id"),c=this.valorComun(e,"comment");$("#set-slot-id").val(e.length===1?e[0].id:"Múltiples"),$("#set-slot-status").val(a!==null?a:"null"),$('#setSlotProperties input[name="comment"]').val(c!==null?c:""),$("#set-slot-name").prop("disabled",e.length!==1).val(e.length===1?e[0].name??"":""),$("#set-slot-x").val(n!==null?n:""),$("#set-slot-y").val(i!==null?i:""),$("#set-slot-zone").val(o!==null?o:""),$("#setSlotProperties").modal("show")},applyModalChanges(){const t=$("#set-slot-status").val(),e=t==="null"?null:+t,o=$('#setSlotProperties input[name="comment"]').val(),n=$("#set-slot-name").prop("disabled")?null:$("#set-slot-name").val().trim(),i=parseFloat($("#set-slot-x").val()),a=parseFloat($("#set-slot-y").val()),c=parseInt($("#set-slot-zone").val(),10)||null;this.selected.forEach(l=>{const s=this.nodesById[l],r=this.slotById[l];n&&(r.name=n),r.status_id=e,r.comment=o,r.x=isNaN(i)?null:i,r.y=isNaN(a)?null:a,r.zone_id=c;const h=e===null?m:this.statusColor[e]??"#666";if(s.style.fill=h,this.hasSingleZone)s.style.stroke=h,s.style.strokeWidth=v;else{const u=this.zoneColorMap[r.zone_id]||"#cccccc";s.style.stroke=u,s.style.strokeWidth=2}this.changed[l]={id:l,name:r.name??null,comment:r.comment??null,status_id:r.status_id??null,x:r.x,y:r.y,zone_id:c}}),document.getElementById("slot_labels_input").value=JSON.stringify(Object.values(this.changed)),$("#setSlotProperties").modal("hide")}},beforeUnmount(){this.cleanupDrag(),this.popoverEl&&(this.popoverEl.remove(),this.popoverEl=null),clearTimeout(this.popoverTimeout)},mounted(){const t=this.$refs.canvas;t.addEventListener("mousedown",o=>{(o.target===t||o.target.tagName==="svg")&&this.startDrag(o)}),this.zoneColorMap=Object.fromEntries(this.zones.map(o=>[o.id,o.color]));const e=new Set(this.slots.map(o=>o.zone_id).filter(o=>o!=null));this.hasSingleZone=e.size===1,fetch(this.svgUrl).then(o=>o.text()).then(o=>{var n,i,a,c,l;if(t.innerHTML=o,this.slotById=Object.fromEntries(this.slots.map(s=>[Number(s.id),s])),this.nodesArray=[...t.querySelectorAll(".slot")],this.nodesById=Object.fromEntries(this.nodesArray.map(s=>[+s.dataset.slotId,s])),this.nodesArray.forEach((s,r)=>{const h=+s.dataset.slotId;this.slotById[h]||(this.slotById[h]={id:h,name:null,comment:null,status_id:null,zone_id:null})}),this.nodesArray.forEach(s=>{const r=+s.dataset.slotId,h=this.slotById[r],u=h.status_id,y=u==null?m:this.statusColor[u]??"#666";if(s.style.fill=y,this.hasSingleZone)s.style.stroke=y,s.style.strokeWidth=v;else{const d=this.zoneColorMap[h.zone_id]||"#cccccc";s.style.stroke=d,s.style.strokeWidth=1}s.style.cursor="pointer",s.addEventListener("mouseenter",d=>{this.showPopover(s,d)}),s.addEventListener("mousemove",d=>{this.currentPopoverNode===s&&this.popoverEl&&this.positionPopover(d)}),s.addEventListener("mouseleave",()=>{this.currentPopoverNode===s&&this.hidePopover()}),s.addEventListener("click",d=>{if(d.stopPropagation(),this.hidePopover(),d.shiftKey&&this.lastIndex!==null){const[x,w]=this.lastIndex<idx?[this.lastIndex,idx]:[idx,this.lastIndex];for(let g=x;g<=w;g++)this.toggleNode(this.nodesArray[g],!0)}else d.ctrlKey||d.metaKey?this.toggleNode(s,!this.selected.has(r)):(this.clearSelection(),this.toggleNode(s,!0));this.lastIndex=idx,this.writeHidden()})}),(n=document.querySelector(".selection-btn-edit"))==null||n.addEventListener("click",()=>this.openEditModal()),(i=document.querySelector("#setSlotProperties .btn-set"))==null||i.addEventListener("click",()=>this.applyModalChanges()),p.dataset.zoomEnabled==="1"){const s=t.querySelector("svg");this.panzoom=Panzoom(s,{maxScale:5,minScale:.5,step:.3,contain:"outside",disablePan:!0,cursor:"",handleStartEvent:r=>{if(this.isDragging)return!1}}),s.parentElement.addEventListener("wheel",r=>{this.isDragging||this.panzoom.zoomWithWheel(r)}),(a=document.querySelector(".btn-zoom-in"))==null||a.addEventListener("click",()=>this.panzoom.zoomIn()),(c=document.querySelector(".btn-zoom-out"))==null||c.addEventListener("click",()=>this.panzoom.zoomOut()),(l=document.querySelector(".btn-reset-zoom"))==null||l.addEventListener("click",()=>this.panzoom.reset())}}).catch(console.error)}},p=document.getElementById("svg-layout"),f=document.getElementById("svg-canvas");p&&f&&Vue.createApp(S,{svgUrl:p.dataset.svgUrl,slots:JSON.parse(p.dataset.slots),zones:JSON.parse(p.dataset.zones),configId:parseInt(p.dataset.configId,10)}).mount(f)})();
